name: ClickUp Notification

on:
  workflow_call:

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Extract ClickUp Task ID
        run: |
          COMMIT_MSG=$(git log -1 --pretty=format:"%s")
          TASKS=$(echo "$COMMIT_MSG" | grep -oE "[A-Z]+-[a-z0-9]+" | tr '\n' ' ')
          echo "TASKS=$TASKS" >> $GITHUB_ENV

      - name: Notify ClickUp
        uses: actions/github-script@v7
        env:
          CLICKUP_API_TOKEN: ${{ secrets.CLICKUP_API_TOKEN }}
        with:
          script: |
            if (!process.env.TASKS) return;
            for (const task of process.env.TASKS.split(' ')) {
              await fetch(
                `https://api.clickup.com/api/v2/task/${task}/comment`,
                {
                  method: 'POST',
                  headers: {
                    Authorization: process.env.CLICKUP_API_TOKEN,
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({
                    comment_text: 'âœ… CI checks completed'
                  })
                }
              );
            }
