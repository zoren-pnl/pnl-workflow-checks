name: Notify ClickUp on CI Failure

# Trigger this workflow after Lint & TypeCheck workflow completes
on:
  workflow_run:
    workflows: ["Lint & TypeCheck"]  # name of your main lint workflow
    types:
      - completed

jobs:
  notify-clickup:
    runs-on: ubuntu-latest

    # Only run if the workflow failed
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract ClickUp task IDs from commits
        id: extract_tasks
        run: |
          # Extract task IDs like CL-123 from commit messages
          TASKS=$(git log origin/${{ github.event.workflow_run.head_branch }}..HEAD --pretty=format:"%s" | grep -oE "CL-[0-9]+" | sort -u | tr '\n' ' ')
          echo "TASKS=$TASKS" >> $GITHUB_ENV
          echo "Found task IDs: $TASKS"

      - name: Notify ClickUp
        uses: actions/github-script@v7
        with:
          script: |
            const axios = require('axios');
            const token = process.env.CLICKUP_API_TOKEN;
            const workflowName = github.workflow;
            const branch = github.event.workflow_run.head_branch;
            const sha = github.event.workflow_run.head_sha;
            const tasks = process.env.TASKS.split(' ');

            for (const taskId of tasks) {
              if (taskId.trim() === "") continue;
              const message = `âš  CI Failed for workflow **${workflowName}**\nBranch: ${branch}\nCommit: ${sha}`;
              try {
                await axios.post(
                  `https://api.clickup.com/api/v2/task/${taskId}/comment`,
                  { comment_text: message },
                  { headers: { Authorization: token } }
                );
                console.log(`Notified ClickUp task ${taskId}`);
              } catch (error) {
                console.error(`Failed to notify ClickUp task ${taskId}:`, error.message);
              }
            }
        env:
          CLICKUP_API_TOKEN: ${{ secrets.CLICKUP_API_TOKEN }}
