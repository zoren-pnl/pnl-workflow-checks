name: Notify ClickUp on CI Status

on:
  workflow_run:
    workflows: ["Lint & TypeCheck"]
    types:
      - completed

jobs:
  notify-clickup:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract ClickUp task IDs from commits
        id: extract_tasks
        run: |
          echo "Fetching commit messages..."
          # Read branch from workflow_run JSON or fallback
          BRANCH=$(jq -r '.workflow_run.head_branch // env.GITHUB_REF' "$GITHUB_EVENT_PATH" | sed 's|refs/heads/||')
          TASKS=$(git log origin/$BRANCH..HEAD --pretty=format:"%s" \
                  | grep -oE "[A-Z]+-([a-z0-9]+):" \
                  | sed 's/.*-//; s/://g' \
                  | sort -u \
                  | tr '\n' ' ')
          echo "TASKS=$TASKS" >> $GITHUB_ENV
          echo "Branch: $BRANCH"
          echo "Found task IDs: $TASKS"

      - name: Notify ClickUp tasks
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const token = process.env.CLICKUP_API_TOKEN;
            const tasks = process.env.TASKS.split(' ').filter(t => t.trim() !== '');
            if (tasks.length === 0) {
              console.log("No ClickUp tasks found in commits.");
            }

            // Read workflow_run from event JSON
            const event = JSON.parse(fs.readFileSync(process.env.GITHUB_EVENT_PATH, 'utf8'));
            const workflowRun = event.workflow_run;

            const workflowName = github.workflow;
            const branch = workflowRun ? workflowRun.head_branch : github.ref.replace('refs/heads/', '');
            const sha = workflowRun ? workflowRun.head_sha : github.sha;
            const runUrl = workflowRun ? workflowRun.html_url : `https://github.com/${github.repository}/actions/runs/${github.run_id}`;
            const conclusion = workflowRun ? workflowRun.conclusion : 'unknown';

            // Map conclusion to emoji/text
            let statusEmoji, statusText;
            switch(conclusion) {
              case 'success': statusEmoji = '✅'; statusText = 'CI Passed'; break;
              case 'failure': statusEmoji = '⚠'; statusText = 'CI Failed'; break;
              case 'cancelled': statusEmoji = '❌'; statusText = 'CI Cancelled'; break;
              default: statusEmoji = 'ℹ'; statusText = `CI ${conclusion}`;
            }

            for (const taskId of tasks) {
              const message = `${statusEmoji} ${statusText} for workflow **${workflowName}**\nBranch: ${branch}\nCommit: ${sha}\n[View workflow run](${runUrl})`;
              try {
                await fetch(`https://api.clickup.com/api/v2/task/${taskId}/comment`, {
                  method: 'POST',
                  headers: {
                    'Authorization': token,
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({ comment_text: message })
                });
                console.log(`✅ Notified ClickUp task ${taskId} with status: ${statusText}`);
              } catch (error) {
                console.error(`❌ Failed to notify ClickUp task ${taskId}: ${error.message}`);
              }
            }
        env:
          CLICKUP_API_TOKEN: ${{ secrets.CLICKUP_API_TOKEN }}
