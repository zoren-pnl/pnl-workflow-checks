name: Notify ClickUp on CI Status

# Trigger after your main lint workflow completes
on:
  workflow_run:
    workflows: ["Lint & TypeCheck"]  # Replace with your main workflow name
    types:
      - completed

jobs:
  notify-clickup:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract ClickUp task IDs from commits
        id: extract_tasks
        run: |
          echo "Fetching commit messages..."
          # Get commit messages from the branch that triggered the workflow
          TASKS=$(git log origin/${{ github.event.workflow_run.head_branch }}..HEAD --pretty=format:"%s" \
                  | grep -oE "[A-Z]+-([a-z0-9]+):" \
                  | sed 's/.*-//; s/://g' \
                  | sort -u \
                  | tr '\n' ' ')
          echo "TASKS=$TASKS" >> $GITHUB_ENV
          echo "Found task IDs: $TASKS"

      - name: Notify ClickUp tasks
        uses: actions/github-script@v7
        with:
          script: |
            const axios = require('axios');
            const token = process.env.CLICKUP_API_TOKEN;
            const workflowName = github.workflow;
            const branch = github.event.workflow_run.head_branch;
            const sha = github.event.workflow_run.head_sha;
            const runUrl = github.event.workflow_run.html_url;
            const conclusion = github.event.workflow_run.conclusion; // success, failure, cancelled, etc.
            const tasks = process.env.TASKS.split(' ');

            if (tasks.length === 0 || (tasks.length === 1 && tasks[0] === "")) {
              console.log("No ClickUp tasks found in commits.");
            }

            // Set status emoji and text based on workflow result
            let statusEmoji, statusText;
            switch(conclusion) {
              case 'success':
                statusEmoji = '✅';
                statusText = 'CI Passed';
                break;
              case 'failure':
                statusEmoji = '⚠';
                statusText = 'CI Failed';
                break;
              case 'cancelled':
                statusEmoji = '❌';
                statusText = 'CI Cancelled';
                break;
              default:
                statusEmoji = 'ℹ';
                statusText = `CI ${conclusion}`;
            }

            // Notify each ClickUp task
            for (const taskId of tasks) {
              if (!taskId.trim()) continue;

              const message = `${statusEmoji} ${statusText} for workflow **${workflowName}**\nBranch: ${branch}\nCommit: ${sha}\n[View workflow run](${runUrl})`;

              try {
                await axios.post(
                  `https://api.clickup.com/api/v2/task/${taskId}/comment`,
                  { comment_text: message },
                  { headers: { Authorization: token } }
                );
                console.log(`✅ Notified ClickUp task ${taskId} with status: ${statusText}`);
              } catch (error) {
                console.error(`❌ Failed to notify ClickUp task ${taskId}: ${error.message}`);
              }
            }
        env:
          CLICKUP_API_TOKEN: ${{ secrets.CLICKUP_API_TOKEN }}