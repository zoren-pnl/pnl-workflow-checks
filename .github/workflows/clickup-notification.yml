name: Notify ClickUp on CI Status

# Trigger after your main Lint & TypeCheck workflow completes
on:
  workflow_run:
    workflows: ["Lint & TypeCheck"] # Replace with your main workflow name
    types:
      - completed

jobs:
  notify-clickup:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract ClickUp task IDs from commits
        id: extract_tasks
        run: |
          echo "Fetching commit messages..."
          # Get commit messages from the branch that triggered the workflow
          TASKS=$(git log origin/${{ github.event.workflow_run?.head_branch || github.ref }}..HEAD --pretty=format:"%s" \
                  | grep -oE "[A-Z]+-([a-z0-9]+):" \
                  | sed 's/.*-//; s/://g' \
                  | sort -u \
                  | tr '\n' ' ')
          echo "TASKS=$TASKS" >> $GITHUB_ENV
          echo "Found task IDs: $TASKS"

      - name: Notify ClickUp tasks
        uses: actions/github-script@v7
        with:
          script: |
            const token = process.env.CLICKUP_API_TOKEN;
            const workflowRun = github.event.workflow_run;
            const workflowName = github.workflow;

            // Fallbacks in case workflow_run is undefined (PRs, forks)
            const branch = workflowRun?.head_branch ?? github.ref.replace('refs/heads/', '');
            const sha = workflowRun?.head_sha ?? github.sha;
            const runUrl = workflowRun?.html_url ?? `https://github.com/${github.repository}/actions/runs/${github.run_id}`;
            const conclusion = workflowRun?.conclusion ?? 'unknown';
            const tasks = process.env.TASKS.split(' ');

            if (tasks.length === 0 || (tasks.length === 1 && tasks[0] === "")) {
              console.log("No ClickUp tasks found in commits.");
            }

            // Set status emoji and text
            let statusEmoji, statusText;
            switch(conclusion) {
              case 'success': statusEmoji = '✅'; statusText = 'CI Passed'; break;
              case 'failure': statusEmoji = '⚠'; statusText = 'CI Failed'; break;
              case 'cancelled': statusEmoji = '❌'; statusText = 'CI Cancelled'; break;
              default: statusEmoji = 'ℹ'; statusText = `CI ${conclusion}`;
            }

            for (const taskId of tasks) {
              if (!taskId.trim()) continue;

              const message = `${statusEmoji} ${statusText} for workflow **${workflowName}**\nBranch: ${branch}\nCommit: ${sha}\n[View workflow run](${runUrl})`;

              try {
                await fetch(`https://api.clickup.com/api/v2/task/${taskId}/comment`, {
                  method: 'POST',
                  headers: {
                    'Authorization': token,
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({ comment_text: message })
                });
                console.log(`✅ Notified ClickUp task ${taskId} with status: ${statusText}`);
              } catch (error) {
                console.error(`❌ Failed to notify ClickUp task ${taskId}: ${error.message}`);
              }
            }
        env:
          CLICKUP_API_TOKEN: ${{ secrets.CLICKUP_API_TOKEN }}