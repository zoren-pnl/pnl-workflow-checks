name: Release Workflow

on:
  pull_request:
    branches: ['main']
    types: [closed]

permissions:
  contents: write

jobs:
  release:
    if: ${{ github.event.pull_request.merged == true }}
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout the release branch (PR head)
      - name: Checkout release branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0

      # 2️⃣ Generate full license report
      - name: Generate full license report
        run: |
          npx license-checker --json --production --excludePrivatePackages --out licenses-full.json

      # 3️⃣ Upload license reports as artifacts
      - name: Upload license artifacts
        uses: actions/upload-artifact@v4
        with:
          name: license-report
          path: |
            THIRD_PARTY_NOTICES.md
            licenses-full.json

      # 4️⃣ Read version from package.json
      - name: Read version
        id: version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      # 5️⃣ Checkout main branch to push tag
      - name: Checkout main branch
        run: |
          git fetch origin main
          git checkout main

      # 6️⃣ Merge release branch into main
      - name: Merge release branch into main
        run: |
          git merge --no-ff ${{ github.event.pull_request.head.ref }} -m "Merge release ${{ github.event.pull_request.head.ref }} into main"

      # 7️⃣ Create a git tag based on version
      - name: Create git tag
        run: |
          git tag -f v${{ steps.version.outputs.version }}
          git push origin v${{ steps.version.outputs.version }} --force

      # 8️⃣ Push main updates
      - name: Push main updates
        run: |
          git push origin main
